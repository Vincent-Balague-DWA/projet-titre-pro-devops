# Playbook complet pour déployer l'architecture React + NestJS + MySQL

- name: Provisionner la base de données MySQL
  hosts: database
  become: yes
  tasks:
    - name: Installer MySQL Server
      apt:
        name: mysql-server
        state: present
        update_cache: yes

    - name: Installer PyMySQL pour les modules Ansible
      apt:
        name: python3-pymysql
        state: present

    - name: Créer la base de données
      community.mysql.mysql_db:
        name: "{{ db_name }}"
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Créer un utilisateur MySQL
      community.mysql.mysql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"
        priv: "{{ db_name }}.*:ALL"
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

- name: Déployer l'API Backend (NestJS) avec Docker
  hosts: backend
  become: yes
  tasks:
    - name: Installer Docker
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Démarrer et activer Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Ajouter l'utilisateur ubuntu au groupe docker
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Récupérer le tag de l'image Docker
      shell: cat /tmp/docker-image-tag.txt
      register: docker_image_tag

    - name: Créer le fichier de configuration Backend
      template:
        src: backend.env.j2
        dest: /tmp/backend.env
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    - name: Arrêter le conteneur existant s'il existe
      shell: |
        docker stop backend || true
        docker rm backend || true
      become_user: ubuntu

    - name: Déployer le Backend avec Docker
      shell: |
        docker pull {{ docker_username }}/devops-todolist:{{ docker_image_tag.stdout }}
        docker run -d \
          --name backend \
          --restart unless-stopped \
          -p 3000:3000 \
          --env-file /tmp/backend.env \
          {{ docker_username }}/devops-todolist:{{ docker_image_tag.stdout }}
      become_user: ubuntu

    - name: Vérifier que le conteneur fonctionne
      shell: docker ps | grep backend
      become_user: ubuntu
      register: container_status

    - name: Afficher le statut du conteneur
      debug:
        msg: "Backend container status: {{ container_status.stdout }}"

- name: Déployer le Frontend React avec Nginx
  hosts: frontend
  become: yes
  tasks:
    - name: Installer Nginx
      apt:
        name: nginx
        state: present
        update_cache: yes

    - name: Créer le dossier frontend
      file:
        path: /var/www/frontend
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Extraire le build Frontend pré-compilé
      shell: |
        cd /var/www/frontend
        tar -xzf /tmp/frontend-build.tar.gz
        rm /tmp/frontend-build.tar.gz
        chown -R www-data:www-data /var/www/frontend

    - name: Configurer Nginx pour servir les fichiers statiques
      template:
        src: nginx-frontend.conf.j2
        dest: /etc/nginx/sites-available/frontend
      notify: restart nginx

    - name: Désactiver le site par défaut
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx

    - name: Activer le site frontend
      file:
        src: /etc/nginx/sites-available/frontend
        dest: /etc/nginx/sites-enabled/frontend
        state: link
      notify: restart nginx

    - name: Démarrer et activer Nginx
      systemd:
        name: nginx
        state: started
        enabled: yes

  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted