name: CI/CD - Déploiement complet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Déploiement Infra + Application
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID:       ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY:   ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_VAR_db_name:          ${{ secrets.DB_NAME }}
      TF_VAR_db_user:          ${{ secrets.DB_USER }}
      TF_VAR_db_password:      ${{ secrets.DB_PASSWORD }}
      TF_VAR_project_name:     devops-todouxlist
      TF_VAR_aws_region:       eu-west-1
      TF_VAR_ssh_public_key_path: ~/.ssh/id_rsa_devops.pub
      TF_VAR_allowed_ssh_ips:  '["88.160.144.47/32"]'  # à adapter

    steps:
      - name: Checkout du dépôt
        uses: actions/checkout@v3

      - name: Installer dépendances Système
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl gnupg software-properties-common
          curl -fsSL https://apt.releases.hashicorp.com/gpg |
            sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
            https://apt.releases.hashicorp.com $(lsb_release -cs) main" |
            sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update
          sudo apt-get install -y terraform ansible

      - name: Préparer la clé SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Générer la clé publique à partir de la clé privée
          ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa_devops.pub

      - name: Déployer l'infrastructure avec Terraform
        working-directory: ./terraform
        run: |
          terraform init
          terraform destroy -auto-approve || true
          # Attendre que AWS supprime vraiment les ressources
          sleep 180  # 3 minutes au lieu de quelques secondes
          terraform apply -auto-approve

      - name: Attendre que les instances soient prêtes
        run: sleep 60

      - name: Déployer l'application avec Ansible
        working-directory: ./ansible
        run: |
          chmod +x deploy-simple.sh
          # Modifier le script pour utiliser la bonne clé SSH
          sed -i 's/id_rsa_devops/id_rsa/g' deploy-simple.sh
          # Exécuter le script
          ./deploy-simple.sh

